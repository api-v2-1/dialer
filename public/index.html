<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Browser Phone Caller - Production Ready</title>
        <script src="https://sdk.twilio.com/js/client/releases/1.14.0/twilio.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .container {
                background: white;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                padding: 40px;
                max-width: 450px;
                width: 100%;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
            }

            .icon-circle {
                width: 80px;
                height: 80px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 20px;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }

            .icon-circle svg {
                width: 40px;
                height: 40px;
                stroke: white;
            }

            h1 {
                color: #1a202c;
                font-size: 28px;
                margin-bottom: 10px;
            }

            .subtitle {
                color: #718096;
                font-size: 14px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            label {
                display: block;
                color: #4a5568;
                font-weight: 600;
                margin-bottom: 8px;
                font-size: 14px;
            }

            input {
                width: 100%;
                padding: 14px 16px;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                font-size: 16px;
                transition: all 0.3s;
            }

            input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            input:disabled {
                background: #f7fafc;
                cursor: not-allowed;
            }

            .status-box {
                background: #f7fafc;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                padding: 16px;
                margin-bottom: 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .status-label {
                color: #4a5568;
                font-weight: 600;
                font-size: 14px;
            }

            .status-value {
                font-weight: 700;
                font-size: 14px;
            }

            .status-initializing {
                color: #a0aec0;
            }
            .status-ready {
                color: #48bb78;
            }
            .status-calling {
                color: #ed8936;
            }
            .status-connected {
                color: #38b2ac;
            }
            .status-error {
                color: #f56565;
            }

            .btn {
                width: 100%;
                padding: 16px;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-call {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .btn-call:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            }

            .btn-hangup {
                background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
                color: white;
            }

            .btn-hangup:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(245, 101, 101, 0.3);
            }

            .alert {
                padding: 12px 16px;
                border-radius: 10px;
                margin-bottom: 20px;
                font-size: 14px;
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .alert-error {
                background: #fed7d7;
                border: 2px solid #fc8181;
                color: #c53030;
            }

            .alert-success {
                background: #c6f6d5;
                border: 2px solid #48bb78;
                color: #22543d;
            }

            .alert-info {
                background: #bee3f8;
                border: 2px solid #4299e1;
                color: #2c5282;
            }

            .hidden {
                display: none;
            }

            .call-timer {
                text-align: center;
                font-size: 32px;
                font-weight: 700;
                color: #667eea;
                margin-bottom: 20px;
                font-variant-numeric: tabular-nums;
            }

            .volume-indicator {
                margin-top: 20px;
                padding: 16px;
                background: #f7fafc;
                border-radius: 10px;
            }

            .volume-label {
                font-size: 12px;
                color: #718096;
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
            }

            .volume-bar {
                width: 100%;
                height: 8px;
                background: #e2e8f0;
                border-radius: 4px;
                overflow: hidden;
            }

            .volume-level {
                height: 100%;
                background: linear-gradient(90deg, #48bb78, #38b2ac);
                width: 0%;
                transition: width 0.1s;
            }

            .spinner {
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .call-info {
                background: #f7fafc;
                border-radius: 10px;
                padding: 16px;
                margin-bottom: 20px;
            }

            .call-info-row {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid #e2e8f0;
            }

            .call-info-row:last-child {
                border-bottom: none;
            }

            .call-info-label {
                color: #718096;
                font-size: 13px;
            }

            .call-info-value {
                color: #2d3748;
                font-weight: 600;
                font-size: 13px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="icon-circle">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                        ></path>
                    </svg>
                </div>
                <h1>Browser Phone Caller</h1>
                <p class="subtitle">Make calls directly from your browser</p>
            </div>

            <div id="errorAlert" class="alert alert-error hidden"></div>
            <div id="successAlert" class="alert alert-success hidden"></div>
            <div id="infoAlert" class="alert alert-info hidden"></div>

            <div class="form-group">
                <label for="phoneNumber">Phone Number</label>
                <input
                    type="tel"
                    id="phoneNumber"
                    placeholder="+1 555-123-4567"
                    maxlength="17"
                    autocomplete="tel"
                />
            </div>

            <div class="status-box">
                <span class="status-label">Status:</span>
                <span id="statusText" class="status-value status-initializing"
                    >Initializing...</span
                >
            </div>

            <div id="callInfo" class="call-info hidden">
                <div class="call-info-row">
                    <span class="call-info-label">Calling:</span>
                    <span id="callingNumber" class="call-info-value">-</span>
                </div>
                <div class="call-info-row">
                    <span class="call-info-label">Duration:</span>
                    <span id="callTimer" class="call-info-value">00:00</span>
                </div>
            </div>

            <button id="callButton" class="btn btn-call" disabled>
                <svg
                    width="20"
                    height="20"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                    ></path>
                </svg>
                <span>Call</span>
            </button>

            <button id="hangupButton" class="btn btn-hangup hidden">
                <svg
                    width="20"
                    height="20"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z"
                    ></path>
                </svg>
                <span>Hang Up</span>
            </button>

            <div id="volumeIndicator" class="volume-indicator hidden">
                <div class="volume-label">
                    <span>Audio Level</span>
                    <span id="volumePercent">0%</span>
                </div>
                <div class="volume-bar">
                    <div id="volumeLevel" class="volume-level"></div>
                </div>
            </div>
        </div>

        <script>
            // Configuration
            const API_BASE_URL = window.location.origin;

            // State
            let device = null;
            let currentConnection = null;
            let callStartTime = null;
            let timerInterval = null;

            // DOM Elements
            const elements = {
                phoneNumber: document.getElementById("phoneNumber"),
                callButton: document.getElementById("callButton"),
                hangupButton: document.getElementById("hangupButton"),
                statusText: document.getElementById("statusText"),
                errorAlert: document.getElementById("errorAlert"),
                successAlert: document.getElementById("successAlert"),
                infoAlert: document.getElementById("infoAlert"),
                callInfo: document.getElementById("callInfo"),
                callingNumber: document.getElementById("callingNumber"),
                callTimer: document.getElementById("callTimer"),
                volumeIndicator: document.getElementById("volumeIndicator"),
                volumeLevel: document.getElementById("volumeLevel"),
                volumePercent: document.getElementById("volumePercent"),
            };

            // Format phone number as user types
            elements.phoneNumber.addEventListener("input", (e) => {
                let value = e.target.value.replace(/\D/g, "");

                if (value.length > 0 && value[0] !== "1") {
                    value = "1" + value;
                }

                if (value.length > 11) {
                    value = value.slice(0, 11);
                }

                let formatted = "";
                if (value.length > 0) formatted += "+" + value[0];
                if (value.length > 1) formatted += " " + value.slice(1, 4);
                if (value.length > 4) formatted += "-" + value.slice(4, 7);
                if (value.length > 7) formatted += "-" + value.slice(7, 11);

                e.target.value = formatted;
            });

            // Initialize application
            async function initialize() {
                try {
                    showInfo("Connecting to server...");

                    // Get access token from server
                    const response = await fetch(`${API_BASE_URL}/api/token`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({}),
                    });

                    if (!response.ok) {
                        throw new Error("Failed to get access token");
                    }

                    const data = await response.json();
                    const token = data.token;

                    // Setup Twilio Device
                    device = new Twilio.Device(token);

                    device.on("ready", () => {
                        hideAlerts();
                        showSuccess("Connected! Ready to make calls");
                        setTimeout(() => hideAlerts(), 3000);
                        updateStatus("Ready to call", "ready");
                        elements.callButton.disabled = false;
                    });

                    device.on("error", (error) => {
                        console.error("Device error:", error);
                        showError("Device error: " + error.message);
                        updateStatus("Error", "error");
                    });

                    device.on("connect", (conn) => {
                        currentConnection = conn;
                        updateStatus("Connected", "connected");
                        elements.callButton.classList.add("hidden");
                        elements.hangupButton.classList.remove("hidden");
                        elements.phoneNumber.disabled = true;
                        elements.callInfo.classList.remove("hidden");
                        elements.volumeIndicator.classList.remove("hidden");
                        startCallTimer();
                    });

                    device.on("disconnect", () => {
                        handleCallEnd();
                    });

                    device.on("cancel", () => {
                        handleCallEnd();
                        showInfo("Call was cancelled");
                        setTimeout(() => hideAlerts(), 3000);
                    });

                    device.on("reject", () => {
                        handleCallEnd();
                        showError("Call was rejected");
                    });
                } catch (error) {
                    console.error("Initialization error:", error);
                    showError("Failed to initialize: " + error.message);
                    updateStatus("Error", "error");
                }
            }

            // Make a call
            elements.callButton.addEventListener("click", async () => {
                const phoneNumber = elements.phoneNumber.value.replace(
                    /\D/g,
                    "",
                );

                if (phoneNumber.length < 11) {
                    showError("Please enter a valid 10-digit phone number");
                    return;
                }

                try {
                    hideAlerts();
                    updateStatus("Calling...", "calling");
                    elements.callButton.disabled = true;
                    elements.callButton.innerHTML = `
                    <div class="spinner"></div>
                    <span>Connecting...</span>
                `;

                    const formattedNumber = "+" + phoneNumber;
                    elements.callingNumber.textContent =
                        formatPhoneDisplay(formattedNumber);

                    // Connect the call
                    const params = {
                        To: formattedNumber,
                    };

                    currentConnection = await device.connect(params);
                } catch (error) {
                    console.error("Call error:", error);
                    showError("Failed to connect call: " + error.message);
                    updateStatus("Ready to call", "ready");
                    elements.callButton.disabled = false;
                    resetCallButton();
                }
            });

            // Hang up call
            elements.hangupButton.addEventListener("click", () => {
                if (currentConnection) {
                    currentConnection.disconnect();
                }
            });

            // Handle call end
            function handleCallEnd() {
                currentConnection = null;
                updateStatus("Ready to call", "ready");
                elements.callButton.classList.remove("hidden");
                elements.hangupButton.classList.add("hidden");
                elements.phoneNumber.disabled = false;
                elements.callButton.disabled = false;
                elements.callInfo.classList.add("hidden");
                elements.volumeIndicator.classList.add("hidden");
                stopCallTimer();
                resetCallButton();
            }

            // Reset call button
            function resetCallButton() {
                elements.callButton.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                <span>Call</span>
            `;
            }

            // Call timer
            function startCallTimer() {
                callStartTime = Date.now();

                timerInterval = setInterval(() => {
                    const elapsed = Math.floor(
                        (Date.now() - callStartTime) / 1000,
                    );
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    elements.callTimer.textContent = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
                }, 1000);
            }

            function stopCallTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                elements.callTimer.textContent = "00:00";
            }

            // Format phone number for display
            function formatPhoneDisplay(number) {
                const cleaned = number.replace(/\D/g, "");
                if (cleaned.length === 11) {
                    return `+${cleaned[0]} (${cleaned.slice(1, 4)}) ${cleaned.slice(4, 7)}-${cleaned.slice(7)}`;
                }
                return number;
            }

            // UI Helper functions
            function updateStatus(text, type) {
                elements.statusText.textContent = text;
                elements.statusText.className = "status-value status-" + type;
            }

            function showError(message) {
                elements.errorAlert.textContent = message;
                elements.errorAlert.classList.remove("hidden");
                elements.successAlert.classList.add("hidden");
                elements.infoAlert.classList.add("hidden");
            }

            function showSuccess(message) {
                elements.successAlert.textContent = message;
                elements.successAlert.classList.remove("hidden");
                elements.errorAlert.classList.add("hidden");
                elements.infoAlert.classList.add("hidden");
            }

            function showInfo(message) {
                elements.infoAlert.textContent = message;
                elements.infoAlert.classList.remove("hidden");
                elements.errorAlert.classList.add("hidden");
                elements.successAlert.classList.add("hidden");
            }

            function hideAlerts() {
                elements.errorAlert.classList.add("hidden");
                elements.successAlert.classList.add("hidden");
                elements.infoAlert.classList.add("hidden");
            }

            // Initialize on page load
            window.addEventListener("DOMContentLoaded", initialize);
        </script>
    </body>
</html>
